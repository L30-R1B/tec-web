<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Bingo - Teste Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 5px; }
        .cartela { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 10px 0; }
        .numero-cartela { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; border-radius: 3px; font-weight: bold; }
        .numero-sorteado { background-color: #ffeb3b; }
        .logs { height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9rem; }
        .numero-sorteio { display: inline-block; width: 40px; height: 40px; line-height: 40px; text-align: center; background-color: #28a745; color: white; border-radius: 50%; margin: 5px; font-weight: bold; }
        .tab-content { padding: 15px 0; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üéØ Sistema de Bingo - Teste Completo</h1>
        
        <div class="alert alert-warning" id="status">
            ‚ö†Ô∏è Testando conex√£o com o backend...
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#auth">Autentica√ß√£o</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sala">Salas & Jogos</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#jogo">Meu Jogo</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin">Administra√ß√£o</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#websocket">WebSocket</button></li>
        </ul>

        <div class="tab-content">
            <!-- ABA: AUTENTICA√á√ÉO -->
            <div class="tab-pane fade show active" id="auth">
                <div class="row">
                    <div class="col-md-6">
                        <h3>Registrar Usu√°rio</h3>
                        <form id="formRegistrar">
                            <div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="nome" required value="Jo√£o Silva"></div>
                            <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="email" required value="joao@example.com"></div>
                            <div class="mb-3"><label>Senha</label><input type="password" class="form-control" id="senha" required value="123456"></div>
                            <button type="submit" class="btn btn-primary">Registrar</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h3>Login</h3>
                        <form id="formLogin">
                            <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="loginEmail" required value="joao@example.com"></div>
                            <div class="mb-3"><label>Senha</label><input type="password" class="form-control" id="loginSenha" required value="123456"></div>
                            <button type="submit" class="btn btn-success">Login</button>
                        </form>
                    </div>
                </div>
                
                <div class="mt-4" id="userInfo" style="display: none;">
                    <h4>Informa√ß√µes do Usu√°rio</h4>
                    <div class="card"><div class="card-body">
                        <p><strong>Nome:</strong> <span id="userNome"></span></p>
                        <p><strong>Email:</strong> <span id="userEmail"></span></p>
                        <p><strong>Cr√©ditos:</strong> R$ <span id="userCreditos"></span></p>
                        <p><strong>Admin:</strong> <span id="userAdmin"></span></p>
                        <button class="btn btn-warning" onclick="logout()">Logout</button>
                    </div></div>
                </div>
            </div>

            <!-- ABA: SALAS & JOGOS -->
            <div class="tab-pane fade" id="sala">
                <h3>Salas Dispon√≠veis</h3>
                <button class="btn btn-info mb-3" onclick="listarSalas()">Atualizar Salas</button>
                <div id="listaSalas"></div>
                
                <h3 class="mt-4">Jogos da Sala</h3>
                <div class="mb-3">
                    <label>ID da Sala:</label>
                    <input type="number" class="form-control" id="salaId" placeholder="ID da sala" value="1">
                    <button class="btn btn-info mt-2" onclick="listarJogos()">Listar Jogos</button>
                </div>
                <div id="listaJogos"></div>
            </div>

            <!-- ABA: MEU JOGO -->
            <div class="tab-pane fade" id="jogo">
                <h3>Comprar Cartela</h3>
                <div class="mb-3">
                    <label>ID do Jogo:</label>
                    <input type="number" class="form-control" id="jogoIdComprar" placeholder="ID do jogo" value="1">
                    <button class="btn btn-success mt-2" onclick="comprarCartela()">Comprar Cartela</button>
                </div>
                
                <h3 class="mt-4">Minhas Cartelas</h3>
                <button class="btn btn-info mb-3" onclick="listarMinhasCartelas()">Atualizar Minhas Cartelas</button>
                <div id="minhasCartelas"></div>
            </div>

            <!-- ABA: ADMINISTRA√á√ÉO -->
            <div class="tab-pane fade" id="admin">
                <div id="adminAcesso" style="display: none;">
                    <div class="alert alert-warning">Apenas usu√°rios administradores podem acessar esta se√ß√£o</div>
                </div>
                
                <div id="adminConteudo" style="display: none;">
                    <h3>Criar Sala</h3>
                    <form id="formCriarSala">
                        <div class="mb-3"><label>Nome da Sala</label><input type="text" class="form-control" id="salaNome" required value="Sala Principal"></div>
                        <div class="mb-3"><label>Descri√ß√£o</label><textarea class="form-control" id="salaDescricao">Sala de bingo principal</textarea></div>
                        <button type="submit" class="btn btn-primary">Criar Sala</button>
                    </form>
                    
                    <h3 class="mt-4">Criar Jogo</h3>
                    <form id="formCriarJogo">
                        <div class="mb-3"><label>ID da Sala</label><input type="number" class="form-control" id="jogoSalaId" required value="1"></div>
                        <div class="mb-3"><label>Pre√ßo da Cartela (R$)</label><input type="number" class="form-control" id="jogoPreco" step="0.01" value="1.00" required></div>
                        <button type="submit" class="btn btn-primary">Criar Jogo</button>
                    </form>
                    
                    <h3 class="mt-4">Gerenciar Jogos</h3>
                    <div class="mb-3">
                        <label>ID do Jogo:</label>
                        <input type="number" class="form-control" id="jogoIdAdmin" placeholder="ID do jogo" value="1">
                        <div class="mt-2">
                            <button class="btn btn-success" onclick="iniciarJogo()">Iniciar Jogo</button>
                            <button class="btn btn-warning" onclick="finalizarJogo()">Finalizar Jogo</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA: WEBSOCKET -->
            <div class="tab-pane fade" id="websocket">
                <h3>Conex√£o WebSocket</h3>
                <div class="mb-3">
                    <label>ID da Sala para Conectar:</label>
                    <input type="number" class="form-control" id="salaWebSocket" placeholder="ID da sala" value="1">
                    <button class="btn btn-primary mt-2" onclick="conectarWebSocket()">Conectar</button>
                    <button class="btn btn-secondary mt-2" onclick="desconectarWebSocket()">Desconectar</button>
                </div>
                
                <h4 class="mt-4">N√∫meros Sorteados</h4>
                <div id="numerosSorteados"></div>
                
                <h4 class="mt-4">Logs em Tempo Real</h4>
                <div class="logs" id="websocketLogs"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes
        const BACKEND_URL = 'http://localhost:8080';
        let token = localStorage.getItem('jwtToken');
        let currentUser = null;
        let stompClient = null;
        let salaConectada = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            verificarBackend();
            verificarAutenticacao();
        });

        // Verificar se backend est√° online
        async function verificarBackend() {
            try {
                // Tenta acessar qualquer endpoint para ver se o backend responde
                const response = await fetch(`${BACKEND_URL}`, {
                    method: 'GET',
                    mode: 'no-cors' // Modo no-cors para evitar problemas de CORS
                }).catch(() => {
                    // Se falhar com no-cors, tenta de forma normal
                    return fetch(`${BACKEND_URL}/api/auth/health`).catch(() => {
                        throw new Error('N√£o foi poss√≠vel conectar ao backend');
                    });
                });

                document.getElementById('status').className = 'alert alert-success';
                document.getElementById('status').innerHTML = '‚úÖ <strong>Backend conectado!</strong> Sistema pronto para uso.';
            } catch (error) {
                document.getElementById('status').className = 'alert alert-danger';
                document.getElementById('status').innerHTML = `
                    ‚ùå <strong>Backend offline ou com problemas!</strong><br>
                    <strong>Solu√ß√µes:</strong><br>
                    1. Verifique se o backend Spring Boot est√° rodando<br>
                    2. Confirme se a URL est√° correta: ${BACKEND_URL}<br>
                    3. Verifique os logs do backend para erros<br>
                    4. Pode ser problema de CORS - vamos contornar<br>
                    <em>Erro: ${error.message}</em>
                `;
            }
        }

        // Verificar autentica√ß√£o
        async function verificarAutenticacao() {
            if (!token) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/usuarios/me`, {
                    headers: {'Authorization': 'Bearer ' + token}
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    exibirInformacoesUsuario();
                } else {
                    throw new Error('Token inv√°lido');
                }
            } catch (error) {
                console.error('Erro de autentica√ß√£o:', error);
                localStorage.removeItem('jwtToken');
                token = null;
            }
        }

        // Exibir informa√ß√µes do usu√°rio
        function exibirInformacoesUsuario() {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userNome').textContent = currentUser.nome;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userCreditos').textContent = currentUser.creditos;
            document.getElementById('userAdmin').textContent = currentUser.isAdmin ? 'Sim' : 'N√£o';
            
            if (currentUser.isAdmin) {
                document.getElementById('adminAcesso').style.display = 'none';
                document.getElementById('adminConteudo').style.display = 'block';
            }
        }

        // Fun√ß√£o utilit√°ria para fazer requisi√ß√µes
        async function fazerRequisicao(url, options = {}) {
            try {
                // Configura headers padr√£o
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const config = {
                    ...options,
                    headers
                };

                console.log(`Fazendo requisi√ß√£o para: ${BACKEND_URL}${url}`);
                
                const response = await fetch(`${BACKEND_URL}${url}`, config);
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    } catch (e) {
                        // Ignora erro ao ler response
                    }
                    throw new Error(errorMessage);
                }
                
                // Tenta parsear como JSON, se falhar retorna texto
                try {
                    return await response.json();
                } catch (e) {
                    return await response.text();
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                throw error;
            }
        }

        // Registrar usu√°rio
        document.getElementById('formRegistrar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            try {
                const data = await fazerRequisicao('/api/auth/registrar', {
                    method: 'POST',
                    body: JSON.stringify({ nome, email, senha })
                });
                
                if (data.token) {
                    token = data.token;
                    localStorage.setItem('jwtToken', token);
                    currentUser = data.usuario;
                    exibirInformacoesUsuario();
                    alert('‚úÖ Registro realizado com sucesso!');
                } else {
                    alert('‚ùå Erro no registro: ' + (data.message || 'Resposta inesperada do servidor'));
                }
            } catch (error) {
                alert('‚ùå Erro no registro: ' + error.message);
            }
        });

        // Login
        document.getElementById('formLogin').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            
            try {
                const data = await fazerRequisicao('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, senha })
                });
                
                if (data.token) {
                    token = data.token;
                    localStorage.setItem('jwtToken', token);
                    currentUser = data.usuario;
                    exibirInformacoesUsuario();
                    alert('‚úÖ Login realizado com sucesso!');
                } else {
                    alert('‚ùå Erro no login: ' + (data.message || 'Credenciais inv√°lidas'));
                }
            } catch (error) {
                alert('‚ùå Erro no login: ' + error.message);
            }
        });

        // Logout
        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('jwtToken');
            document.getElementById('userInfo').style.display = 'none';
            alert('Logout realizado');
        }

        // Listar salas
        async function listarSalas() {
            if (!token) {
                alert('‚ö†Ô∏è Fa√ßa login primeiro');
                return;
            }
            
            try {
                const salas = await fazerRequisicao('/api/salas');
                const listaSalas = document.getElementById('listaSalas');
                listaSalas.innerHTML = '';
                
                if (salas.length === 0) {
                    listaSalas.innerHTML = '<p>Nenhuma sala encontrada. Crie uma sala primeiro na aba Administra√ß√£o.</p>';
                    return;
                }
                
                salas.forEach(sala => {
                    const salaDiv = document.createElement('div');
                    salaDiv.className = 'card mb-2';
                    salaDiv.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${sala.nome}</h5>
                            <p class="card-text">${sala.descricao || 'Sem descri√ß√£o'}</p>
                            <p class="card-text"><small class="text-muted">ID: ${sala.idSala}</small></p>
                        </div>
                    `;
                    listaSalas.appendChild(salaDiv);
                });
            } catch (error) {
                alert('‚ùå Erro ao listar salas: ' + error.message);
            }
        }

        // Listar jogos
        async function listarJogos() {
            if (!token) {
                alert('‚ö†Ô∏è Fa√ßa login primeiro');
                return;
            }
            
            const salaId = document.getElementById('salaId').value;
            if (!salaId) {
                alert('‚ö†Ô∏è Informe o ID da sala');
                return;
            }
            
            try {
                const jogos = await fazerRequisicao(`/api/salas/${salaId}/jogos`);
                const listaJogos = document.getElementById('listaJogos');
                listaJogos.innerHTML = '';
                
                if (jogos.length === 0) {
                    listaJogos.innerHTML = '<p>Nenhum jogo encontrado para esta sala. Crie um jogo primeiro na aba Administra√ß√£o.</p>';
                    return;
                }
                
                jogos.forEach(jogo => {
                    const jogoDiv = document.createElement('div');
                    jogoDiv.className = 'card mb-2';
                    jogoDiv.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">Jogo #${jogo.idJogo}</h5>
                            <p class="card-text">Status: <span class="badge bg-${getStatusBadgeColor(jogo.status)}">${jogo.status}</span></p>
                            <p class="card-text">Pre√ßo: R$ ${jogo.precoCartela}</p>
                            <p class="card-text">Data: ${new Date(jogo.dataHora).toLocaleString()}</p>
                            ${jogo.usuarioVencedor ? `<p class="card-text">Vencedor: ${jogo.usuarioVencedor.nome}</p>` : ''}
                        </div>
                    `;
                    listaJogos.appendChild(jogoDiv);
                });
            } catch (error) {
                alert('‚ùå Erro ao listar jogos: ' + error.message);
            }
        }

        // Comprar cartela
        async function comprarCartela() {
            if (!token) {
                alert('‚ö†Ô∏è Fa√ßa login primeiro');
                return;
            }
            
            const jogoId = document.getElementById('jogoIdComprar').value;
            if (!jogoId) {
                alert('‚ö†Ô∏è Informe o ID do jogo');
                return;
            }
            
            try {
                const cartela = await fazerRequisicao(`/api/jogos/${jogoId}/comprar-cartela`, {
                    method: 'POST'
                });
                
                alert('‚úÖ Cartela comprada com sucesso!');
                exibirCartela(cartela);
                verificarAutenticacao(); // Atualizar cr√©ditos
            } catch (error) {
                alert('‚ùå Erro ao comprar cartela: ' + error.message);
            }
        }

        // Exibir cartela
        function exibirCartela(cartela) {
            const minhasCartelas = document.getElementById('minhasCartelas');
            const cartelaDiv = document.createElement('div');
            cartelaDiv.className = 'card mb-3';
            
            let numerosHTML = '<div class="cartela">';
            if (cartela.numeros && Array.isArray(cartela.numeros)) {
                cartela.numeros.forEach(numero => {
                    numerosHTML += `<div class="numero-cartela">${numero}</div>`;
                });
            } else {
                numerosHTML = '<p>N√∫meros da cartela n√£o dispon√≠veis</p>';
            }
            numerosHTML += '</div>';
            
            cartelaDiv.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Cartela #${cartela.idCartela}</h5>
                    <p class="card-text">Jogo: ${cartela.jogo?.idJogo || 'N/A'}</p>
                    ${numerosHTML}
                </div>
            `;
            
            minhasCartelas.appendChild(cartelaDiv);
        }

        // Listar minhas cartelas
        function listarMinhasCartelas() {
            alert('üìã Funcionalidade em desenvolvimento. Use "Comprar Cartela" para testar.');
        }

        // ADMIN: Criar sala
        document.getElementById('formCriarSala').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isAdmin()) return;
            
            const nome = document.getElementById('salaNome').value;
            const descricao = document.getElementById('salaDescricao').value;
            
            try {
                const sala = await fazerRequisicao('/api/admin/salas', {
                    method: 'POST',
                    body: JSON.stringify({ nome, descricao })
                });
                
                alert('‚úÖ Sala criada com sucesso! ID: ' + sala.idSala);
                document.getElementById('formCriarSala').reset();
            } catch (error) {
                alert('‚ùå Erro ao criar sala: ' + error.message);
            }
        });

        // ADMIN: Criar jogo
        document.getElementById('formCriarJogo').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isAdmin()) return;
            
            const idSala = document.getElementById('jogoSalaId').value;
            const precoCartela = document.getElementById('jogoPreco').value;
            
            try {
                const jogo = await fazerRequisicao('/api/admin/jogos', {
                    method: 'POST',
                    body: JSON.stringify({ idSala, precoCartela })
                });
                
                alert('‚úÖ Jogo criado com sucesso! ID: ' + jogo.idJogo);
                document.getElementById('formCriarJogo').reset();
            } catch (error) {
                alert('‚ùå Erro ao criar jogo: ' + error.message);
            }
        });

        // ADMIN: Iniciar jogo
        async function iniciarJogo() {
            if (!isAdmin()) return;
            
            const jogoId = document.getElementById('jogoIdAdmin').value;
            if (!jogoId) {
                alert('‚ö†Ô∏è Informe o ID do jogo');
                return;
            }
            
            try {
                await fazerRequisicao(`/api/admin/jogos/${jogoId}/iniciar`, {
                    method: 'POST'
                });
                
                alert('‚úÖ Jogo iniciado com sucesso!');
                conectarWebSocket();
            } catch (error) {
                alert('‚ùå Erro ao iniciar jogo: ' + error.message);
            }
        }

        // ADMIN: Finalizar jogo
        async function finalizarJogo() {
            if (!isAdmin()) return;
            
            const jogoId = document.getElementById('jogoIdAdmin').value;
            if (!jogoId) {
                alert('‚ö†Ô∏è Informe o ID do jogo');
                return;
            }
            
            try {
                await fazerRequisicao(`/api/admin/jogos/${jogoId}/finalizar`, {
                    method: 'POST'
                });
                
                alert('‚úÖ Jogo finalizado com sucesso!');
            } catch (error) {
                alert('‚ùå Erro ao finalizar jogo: ' + error.message);
            }
        }

        // Verificar se √© admin
        function isAdmin() {
            if (!token || !currentUser || !currentUser.isAdmin) {
                alert('‚õî Acesso negado. Apenas administradores podem executar esta a√ß√£o.');
                return false;
            }
            return true;
        }

        // WebSocket
        function conectarWebSocket() {
            const salaId = document.getElementById('salaWebSocket').value;
            if (!salaId) {
                alert('‚ö†Ô∏è Informe o ID da sala');
                return;
            }
            
            if (stompClient && stompClient.connected) {
                stompClient.disconnect();
            }
            
            const socket = new SockJS(`${BACKEND_URL}/ws`);
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                adicionarLog('‚úÖ Conectado ao WebSocket');
                salaConectada = salaId;
                
                stompClient.subscribe('/topic/sala/' + salaId, function(message) {
                    const mensagem = JSON.parse(message.body);
                    processarMensagemWebSocket(mensagem);
                });
                
                adicionarLog(`üì° Ouvindo eventos da sala ${salaId}`);
            }, function(error) {
                adicionarLog('‚ùå Erro na conex√£o WebSocket: ' + error);
            });
        }

        function desconectarWebSocket() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect();
                adicionarLog('üîå Desconectado do WebSocket');
                salaConectada = null;
            }
        }

        function processarMensagemWebSocket(mensagem) {
            adicionarLog(`üì® ${mensagem.tipo}`);
            
            switch(mensagem.tipo) {
                case 'NOVO_NUMERO':
                    adicionarNumeroSorteado(mensagem.data.numeroSorteado);
                    adicionarLog(`üé≤ N√∫mero sorteado: ${mensagem.data.numeroSorteado}`);
                    break;
                case 'JOGO_INICIADO':
                    adicionarLog(`üöÄ Jogo iniciado: ${mensagem.data.jogoId}`);
                    break;
                case 'FIM_DE_JOGO':
                    adicionarLog(`üéâ FIM DE JOGO! Vencedor: ${mensagem.data.vencedor.nome}`);
                    break;
                default:
                    adicionarLog(`üì¶ Mensagem: ${JSON.stringify(mensagem)}`);
            }
        }

        function adicionarNumeroSorteado(numero) {
            const numerosSorteados = document.getElementById('numerosSorteados');
            const numeroDiv = document.createElement('span');
            numeroDiv.className = 'numero-sorteio';
            numeroDiv.textContent = numero;
            numerosSorteados.appendChild(numeroDiv);
        }

        function adicionarLog(mensagem) {
            const logs = document.getElementById('websocketLogs');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${mensagem}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function getStatusBadgeColor(status) {
            switch(status) {
                case 'AGUARDANDO': return 'warning';
                case 'EM_ANDAMENTO': return 'success';
                case 'FINALIZADO': return 'secondary';
                default: return 'light';
            }
        }
    </script>
</body>
</html>
